<!DOCTYPE html>
<html lang="en">
<head>
  <title>Geologic Map of Ice Age Trail</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Interactive geologic map of the Ice Age Trail featuring trail segments, parking, camping, and geologic insights." />
  <link rel="icon" href="TG.png">

  <!-- ArcGIS API CSS and JS -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.25/"></script>

  <!-- Inline CSS for layout and style -->
  <style>
    /* Reset basic elements and set font */
    html, body, #viewDiv {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }
    body {
      font-family: "Century Gothic", sans-serif;
    }
    /* Header styles */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #0077D4; /* IAT Blue */
      color: #ffffff;
      padding: 10px 20px;
    }
    .header h1 {
      margin: 0;
      font-size: 1.4em;
    }
    .addRecordBtn {
      background-color: #ff6700;
      color: #ffffff;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      text-decoration: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .addRecordBtn:hover {
      background-color: #ff6700;
    }
    /* Map container: leave space for header */
    #viewDiv {
      height: calc(100% - 60px);
    }
    /* Popup styling */
    .esri-popup {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .esri-popup__header {
      background-color: #0077D4;
      color: #ffffff;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      padding: 10px 15px;
      font-weight: 500;
    }
    .esri-popup__content {
      background-color: rgba(0, 119, 212, 0.1);
      padding: 15px;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2),
                  0 6px 20px rgba(0, 0, 0, 0.19);
      position: relative;
      text-align: center;
    }
    .modal-content h2 {
      margin-top: 0;
    }
    .modal-content img {
      margin: 10px 0;
    }
    .modal-text {
      text-align: left;
    }
    .modal-text ul {
      padding-left: 20px;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: #000;
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <div class="header">
    <h1>Geologic Map of Ice Age Trail</h1>
    <a href="https://survey123.arcgis.com/share/28999d44a3004264b788805abd470022" target="_blank" class="addRecordBtn">Report Trail Issue</a>
  </div>

  <!-- Map Container -->
  <div id="viewDiv"></div>

  <!-- Welcome Modal -->
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Welcome to the Geologic Map of the Ice Age Trail!</h2>
      <img src="LOGO_Ice-Age-Trail-Alliance-JPG-1267x1536.jpg" alt="Ice Age Trail Alliance Logo" width="125" height="150" />
      <div class="modal-text">
        <p>Your ultimate companion for exploring the geology and trail features of the Ice Age Trail.</p>
        <ul>
          <li><strong>Geologic Insights:</strong> Discover bedrock formations and glacial features along the trail.</li>
          <li><strong>Interactive Mapping:</strong> Navigate detailed maps showing trail segments, campgrounds, and water sources.</li>
          <li><strong>Report Issues:</strong> Quickly report trail hazards or maintenance concerns.</li>
          <li><strong>Community Contributions:</strong> See contributions from fellow hikers and share your experiences.</li>
        </ul>
        <p>Explore, report, and enjoy the natural beauty of the Ice Age Trail with our interactive geologic map!</p>
      </div>
    </div>
  </div>

  <!-- ArcGIS API and Application Script -->
  <script>
    // Modal functionality
    var modal = document.getElementById("myModal");
    var closeBtn = document.getElementsByClassName("close")[0];
    window.onload = function() {
      modal.style.display = "block";
    };
    closeBtn.onclick = function() {
      modal.style.display = "none";
    };
    window.onclick = function(event) {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    };

    // Load ArcGIS modules and create the map
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/widgets/BasemapGallery",
      "esri/widgets/Locate",
      "esri/widgets/Search",
      "esri/widgets/Expand",
      "esri/layers/FeatureLayer",
      "esri/renderers/SimpleRenderer",
      "esri/renderers/UniqueValueRenderer",
      "esri/symbols/SimpleLineSymbol",
      "esri/symbols/SimpleFillSymbol",
      "esri/Color",
      "esri/widgets/LayerList"
    ], function(esriConfig, Map, MapView, BasemapGallery, Locate, Search, Expand, FeatureLayer, SimpleRenderer, UniqueValueRenderer, SimpleLineSymbol, SimpleFillSymbol, Color, LayerList) {

      // Set API key (Double-check your API key)
      esriConfig.apiKey = "AAPKddba40c16f2c479188ee7654064642bcKj2RV3mAHrsiJS_6TRKUzkim46MXbNeE97z3bQn0zq3zyX67A3i8hBg6lEH0Fxl_";
      
      // Create the map with the light-gray basemap
      const map = new Map({ basemap: "arcgis-light-gray" });
      
      // Create the MapView centered on Wisconsin
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-89.8505, 44.8505],
        zoom: 9
      });
      
      // Add Basemap Gallery widget inside an Expand widget
      const bgGallery = new BasemapGallery({ view: view });
      view.ui.add(new Expand({ view: view, content: bgGallery }), "bottom-right");
      
      // Add Locate widget
      view.ui.add(new Locate({ view: view }), "top-left");
      
      // Add Search widget inside an Expand widget
      const searchWidget = new Search({ view: view, suggestionsEnabled: true, maxSuggestions: 3 });
      view.ui.add(new Expand({
        view: view,
        content: searchWidget,
        expandIconClass: "esri-icon-search",
        expandTooltip: "Search"
      }), { position: "top-left", index: 2 });
      
      // =====================
      // Define FeatureLayers
      // =====================
      
      // Bedrock Geology layer
      const bedrockGeology = new FeatureLayer({
        url: "https://services1.arcgis.com/kkX9mRo34fTGAX96/arcgis/rest/services/Simplified_Marathon_Bedrock/FeatureServer",
        title: "Bedrock Geology",
        listMode: "show",
        outFields: ["simple", "Descr", "Age"],
        popupTemplate: {
          title: "Bedrock Geology",
          content: "<b>Rock Name:</b> {simple}<br><br><b>Age:</b> {Age}<br><br><b>Description:</b> {Descr}"
        }
      });
      map.add(bedrockGeology);
      
      // Glacial Geology layer
      const glacialGeology = new FeatureLayer({
        url: "https://services1.arcgis.com/kkX9mRo34fTGAX96/arcgis/rest/services/Simple_Marathon_Glacial/FeatureServer",
        title: "Glacial Geology",
        listMode: "show",
        outFields: ["Name", "Descr", "Direction", "Age"],
        popupTemplate: {
          title: "Glacial Geology",
          content: `<b>Feature Name:</b> {Name}<br><br>
                    <b>Direction:</b> {Direction}<br><br>
                    <b>Age:</b> {Age}<br><br>
                    <b>Description:</b> {Descr}`
        }
      });
      map.add(glacialGeology);
      
      // IAT Sections layer – these are the available segments
      // Double-check field names: "Segment" and "Status" must match your data.
      const sectionsPopupTemplate = {
        title: "Section or Connecting Route",
        content: [
          {
            type: "text",
            text: `<div style="margin-bottom: 10px;"><b>Name:</b> {Segment}</div>
                   <div style="margin-bottom: 10px;"><b>Type:</b> {Status}</div>`
          },
          {
            type: "fields",
            fieldInfos: [{
              fieldName: "length_mi",
              label: "Length (mi)",
              format: { places: 1, digitSeparator: true }
            }]
          }
        ],
        actions: [{
          title: "Mark as Completed",
          id: "completeSegment",
          className: "esri-icon-check",
          visible: true,
          label: "Mark as Completed"
        }]
      };
      
      const sections = new FeatureLayer({
        url: "https://services.arcgis.com/EeCmkqXss9GYEKIZ/arcgis/rest/services/IAT_Segments_CR/FeatureServer",
        title: "IAT Sections and Connecting Routes",
        listMode: "show",
        outFields: ["Segment", "length_mi", "Status"],
        popupTemplate: sectionsPopupTemplate
      });
      map.add(sections);

      // Create a SimpleLineSymbol with a bold yellow appearance
      const yellowLineSymbol = new SimpleLineSymbol({
        color: new Color([251, 222, 74]), // Bold yellow color
        width: "5px",                   // Bold (thick) line
        style: "solid"
      });

      // Use a SimpleRenderer to apply this symbol to every feature in mySegments
      const mySegmentsRenderer = new SimpleRenderer({
        symbol: yellowLineSymbol
      });
      
      // Completed Segments layer – where completed segments will be added
      const mySegments = new FeatureLayer({
        url: "https://services1.arcgis.com/kkX9mRo34fTGAX96/arcgis/rest/services/Completed_IAT_Segments/FeatureServer",
        title: "Segment Completed",
        outFields: ["SegmentName", "DateCompleted", "Length_mi"],
        renderer: mySegmentsRenderer
      });
      map.add(mySegments);
      
      // =====================
      // Popup Action and Editing
      // =====================
      
      // Listen for the custom popup action: "Mark as Completed"
      view.popup.on("trigger-action", function(event) {
        if (event.action.id === "completeSegment") {
          // Get the selected feature from the sections layer
          const selectedFeature = view.popup.selectedFeature;
          if (selectedFeature) {
            completeSegment(selectedFeature);
          }
        }
      });
      
      // Function to mark a segment as completed:
      function completeSegment(feature) {
        // Build a new feature to add to the completed segments layer.
        // Verify the attribute names ("Segment", "SegmentName", etc.) match your service schema.
        let newCompletedSegment = {
          geometry: feature.geometry,  // Copy the existing geometry
          attributes: {
            SegmentName: feature.attributes.Segment, // Double-check that this field name is correct.
            DateCompleted: new Date().toISOString().slice(0, 10), // Today's date in YYYY-MM-DD format.
            Comments: "Reported as completed" // Optional additional information.
          }
        };

        // Add the new feature to the Completed Segments layer using applyEdits
        mySegments.applyEdits({
          addFeatures: [newCompletedSegment]
        }).then(function(result) {
          if (result.addFeatureResults && result.addFeatureResults[0].error) {
            alert("Error reporting segment completion.");
          } else {
            alert("Segment successfully reported as completed!");
            
            // Optionally update the original section's status to "completed"
            // so its renderer changes (e.g., from red to yellow)
            let updatedFeature = feature.clone();
            updatedFeature.attributes.Status = "completed"; // Ensure your renderer uses this value.
            sections.applyEdits({
              updateFeatures: [updatedFeature]
            }).then(function(updateResult) {
              console.log("Section updated for visual feedback.");
            }).catch(function(error) {
              console.error("Error updating section: ", error);
            });
          }
        }).catch(function(error) {
          console.error("Error applying edits: ", error);
          alert("An unexpected error occurred.");
        });
      }
      
      // =====================
      // Additional Layers
      // =====================
      
      // IAT Parking layer
      const parkingPopupTemplate = {
        title: "Parking Area",
        content: `<div style="margin-bottom: 10px;"><b>Parking Type:</b> {Parking_Type}</div>
                  <div style="margin-bottom: 10px;"><b>Description:</b> {Description}</div>
                  <div style="margin-bottom: 10px;"><b>Fee:</b> {Fee}</div>
                  <div style="margin-bottom: 10px;"><b>Overnight Parking:</b> {Overnight_Park}</div>
                  <div style="margin-bottom: 10px;"><b>Parking Notes: </b> {Parking_Notes}`
      };
      const parking = new FeatureLayer({
        url: "https://services.arcgis.com/EeCmkqXss9GYEKIZ/arcgis/rest/services/IAT_Parking/FeatureServer",
        title: "Parking Areas",
        listMode: "show",
        outFields: ["Parking_Type", "Description", "Fee", "Overnight_Park", "Parking_Notes"],
        popupTemplate: parkingPopupTemplate
      });
      map.add(parking);
      
      // IAT Camping layer
      const campingPopupTemplate = {
        title: "Campgrounds",
        content: `<div style="margin-bottom: 10px;"><b>Type:</b> {Camp_Type}</div>
                  <div style="margin-bottom: 10px;"><b># sites:</b> {Num_Sites}</div>
                  <div style="margin-bottom: 10px;"><b>Water:</b> {Water}</div>
                  <div style="margin-bottom: 10px;"><b>Toilet:</b> {Toilet}</div>
                  <div style="margin-bottom: 10px;"><b>Showers:</b> {Showers}</div>
                  <div><b>Description:</b> {Comment}</div>`
      };
      const campgrounds = new FeatureLayer({
        url: "https://services.arcgis.com/EeCmkqXss9GYEKIZ/arcgis/rest/services/IAT___Campgrounds_NEW/FeatureServer",
        title: "Camping Areas",
        outFields: ["Camp_Type", "Num_Sites", "Water", "Toilet", "Showers", "Comment"],
        popupTemplate: campingPopupTemplate
      });
      map.add(campgrounds);
      
      // IAT Potable Water layer
      const waterPopupTemplate = {
        title: "Potable Water",
        content: `<div style="margin-bottom: 10px;"><b>Feature Type:</b> {Feature Type}</div>
                  <div style="margin-bottom: 10px;"><b>Reliability:</b> {Reliability}</div>
                  <div><b>Comment:</b> {Comment}</div>`
      };
      const waterLayer = new FeatureLayer({
        url: "https://services.arcgis.com/EeCmkqXss9GYEKIZ/arcgis/rest/services/IAT_Potable_Water/FeatureServer",
        title: "Potable Water",
        listMode: "show",
        outFields: ["Feature Type", "Reliability", "Comment"],
        popupTemplate: waterPopupTemplate
      });
      map.add(waterLayer);
      
      // IAT Trail Communities layer
      const communityRenderer = {
        type: "simple",
        symbol: {
          type: "picture-marker",
          url: "https://raw.githubusercontent.com/ecolville/IAT_Geology/main/Generic-Trail-Community-Logo.png",
          width: "20px",
          height: "20px"
        }
      };
      const communities = new FeatureLayer({
        url: "https://services.arcgis.com/EeCmkqXss9GYEKIZ/arcgis/rest/services/Ice_Age_Trail_Communities_View/FeatureServer",
        title: "Trail Communities",
        listMode: "show",
        renderer: communityRenderer
      });
      communities.popupTemplate = { title: "{Name}" };
      map.add(communities);
      
      // IAT Trail Hazards layer
      const hazards = new FeatureLayer({
        url: "https://services1.arcgis.com/kkX9mRo34fTGAX96/arcgis/rest/services/survey123_28999d44a3004264b788805abd470022_results/FeatureServer",
        title: "Trail Hazards & Maintenance Issues",
        listMode: "show",
        renderer: {
          type: "simple",
          symbol: {
            type: "picture-marker",
            url: "https://raw.githubusercontent.com/ecolville/IAT_Geology/main/hazard.png",
            width: "20px",
            height: "30px"
          }
        }
      });
      hazards.popupTemplate = {
        title: "Trail Hazards and Maintenance Issue",
        content: `<div style="margin-bottom: 10px;"><b>Date of Observation:</b> {observation_date_and_time}</div>
                  <div style="margin-bottom: 10px;"><b>Location:</b> {trail_segment_name} {mile_marker}</div>
                  <div style="margin-bottom: 10px;"><b>Hazard/Maintenance Need:</b> {hazardmaintenance_need}</div>
                  <div style="margin-bottom: 10px;"><b>Description:</b> {description}</div>
                  <div><b>Severity of Issue:</b> {level_of_severity}</div>`
      };
      map.add(hazards);
      
      // Add the LayerList widget once the view is ready
      view.when(() => {
        const layerList = new LayerList({ view: view });
        view.ui.add(new Expand({
          view: view,
          content: layerList,
          expandIconClass: "esri-icon-layer-list",
          expandTooltip: "Layers",
          expanded: true
        }), "top-right");
      });
      
    }); // End require
  </script>
</body>
</html>
